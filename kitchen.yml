---

TerraformVerifier: &terraform_verifier
  name: Terraform
  backend: local
  controls:
    - "Terraform State"
    - "Terraform Network"
    - "Terraform NAT Gateway"
    - "Terraform Grafana"
    - "Terraform Grafana Load Balancer"
  show_progress: true

NatGatewayVerifier: &nat_gateway_verifier
  name: NAT Gateway
  backend: ssh
  user: root
  controls:
    - "Default Firewall"
    - "Role Docker"
    - "Role Node Exporter"
    - "Role Promtail"
  hosts_output: nat_gateway_ip_address
  show_progress: true

GrafanaVerifier: &grafana_verifier
  name: Grafana Server
  backend: ssh
  user: root
  controls:
    - "Default Firewall"
    - "Role Docker"
    - "Role Node Exporter"
    - "Role Loki"
    - "Role Promtail"
    - "Role Grafana OSS"
    - "Role Prometheus"
  bastion_host_output: nat_gateway_ip_address
  hosts_output: grafana_private_ip_address
  show_progress: true

PrivateNetworkServer: &private_network_server
  name: Private Network Server
  backend: ssh
  user: root
  controls:
    - "Default Firewall"
    - "Role Docker"
    - "Role Node Exporter"
    - "Role Promtail"
    - "Data Volume"
  bastion_host_output: nat_gateway_ip_address
  hosts_output: private_network_server_ip
  show_progress: true

VagrantDriver: &vagrant_driver
  name: vagrant
  box: bento/ubuntu-22.04-arm64
  provider: vmware_desktop
  network:
    - ["private_network"]

AnsibleProvisioner: &ansible_provisioner
  name                : ansible_push
  chef_bootstrap_url  : nil
  host_key_checking   : false
  idempotency_test    : true
  fail_non_idempotent : true
  environment_vars:
    ANSIBLE_ROLES_PATH: "./roles"
    ANSIBLE_CALLBACKS_ENABLED: "changes"
    OBJC_DISABLE_INITIALIZE_FORK_SAFETY: "YES"

platforms:
  - name: prvsn-internal-network-firewall
    driver:
      <<: *vagrant_driver
    provisioner:
      <<: *ansible_provisioner
      extra_vars:
        roles_to_include:
          - prvsn_internal_network_firewall
      playbook : "./test/test.yml"
    verifier:
      name: inspec
      controls:
        - "Default Firewall"

  - name: prvsn-nat-gateway
    driver:
      <<: *vagrant_driver
    provisioner:
      <<: *ansible_provisioner
      extra_vars:
        roles_to_include:
          - prvsn_nat_gateway
      playbook : "./test/test.yml"
    verifier:
      name: inspec
      controls:
        - "Default Firewall"

  - name: prvsn-docker
    driver:
      <<: *vagrant_driver
    provisioner:
      <<: *ansible_provisioner
      extra_vars:
        roles_to_include:
          - prvsn_docker
      playbook : "./test/test.yml"
    verifier:
      name: inspec
      controls:
        - "Role Docker"

  - name: prvsn-node-exporter
    driver:
      <<: *vagrant_driver
    provisioner:
      <<: *ansible_provisioner
      extra_vars:
        roles_to_include:
          - prvsn_internal_network_firewall
          - prvsn_node_exporter
      playbook : "./test/test.yml"
    verifier:
      name: inspec
      controls:
        - "Role Node Exporter"

  - name: prvsn-promtail
    driver:
      <<: *vagrant_driver
    provisioner:
      <<: *ansible_provisioner
      extra_vars:
        roles_to_include:
          - prvsn_docker
          - prvsn_promtail
        prvsn_promtail_loki_server: localhost
      playbook : "./test/test.yml"
    verifier:
      name: inspec
      controls:
        - "Role Promtail"

  - name: prvsn-loki
    driver:
      <<: *vagrant_driver
    provisioner:
      <<: *ansible_provisioner
      extra_vars:
        roles_to_include:
          - prvsn_internal_network_firewall
          - prvsn_loki
      playbook : "./test/test.yml"
    verifier:
      name: inspec
      controls:
        - "Role Loki"

  - name: prvsn-grafana-oss
    driver:
      <<: *vagrant_driver
    provisioner:
      <<: *ansible_provisioner
      extra_vars:
        roles_to_include:
          - prvsn_internal_network_firewall
          - prvsn_grafana_oss
      playbook : "./test/test.yml"
    verifier:
      name: inspec
      controls:
        - "Role Grafana OSS"

  - name: prvsn-prometheus
    driver:
      <<: *vagrant_driver
    provisioner:
      <<: *ansible_provisioner
      extra_vars:
        roles_to_include:
          - prvsn_internal_network_firewall
          - prvsn_prometheus
        prvsn_prometheus_network_name: "a_network_name"
        prvsn_prometheus_hcloud_read_token: "abcd"
      playbook : "./test/test.yml"
    verifier:
      name: inspec
      controls:
        - "Role Prometheus"

  - name: hcloud-starter-eu-central
    provisioner:
      name: terraform
    transport:
      name: terraform
      root_module_directory: test/fixtures/default
    driver:
      name: terraform
      parallelism: 1
      variables:
        name: "eu-central-test"
        network_zone: "eu-central"
        network_cidr: "10.1.0.0/16"
        ssh_key_id: "12940863"
    verifier:
      name: terraform
      systems:
        - <<: *terraform_verifier
          attrs:
            - test/integration/default/terraform_attributes/eu_central.yml
        - <<: *nat_gateway_verifier
          attrs:
            - test/integration/default/terraform_attributes/eu_central.yml
            - test/integration/default/terraform_attributes/all.yml
        - <<: *grafana_verifier
          attrs:
            - test/integration/default/terraform_attributes/eu_central.yml
            - test/integration/default/terraform_attributes/all.yml
        - <<: *private_network_server
          attrs:
            - test/integration/default/terraform_attributes/eu_central.yml
            - test/integration/default/terraform_attributes/all.yml

  - name: hcloud-starter-us-east
    provisioner:
      name: terraform
    transport:
      name: terraform
      root_module_directory: test/fixtures/default
    driver:
      name: terraform
      parallelism: 1
      variables:
        name: "us-east-test"
        network_zone: "us-east"
        network_cidr: "10.2.0.0/16"
        ssh_key_id: "12940863"
    verifier:
      name: terraform
      systems:
        - <<: *terraform_verifier
          attrs:
            - test/integration/default/terraform_attributes/us_east.yml
        - <<: *nat_gateway_verifier
          attrs:
            - test/integration/default/terraform_attributes/us_east.yml
            - test/integration/default/terraform_attributes/all.yml
        - <<: *grafana_verifier
          attrs:
            - test/integration/default/terraform_attributes/us_east.yml
            - test/integration/default/terraform_attributes/all.yml
        - <<: *private_network_server
          attrs:
            - test/integration/default/terraform_attributes/us_east.yml
            - test/integration/default/terraform_attributes/all.yml

  - name: hcloud-starter-us-west
    provisioner:
      name: terraform
    transport:
      name: terraform
      root_module_directory: test/fixtures/default
    driver:
      name: terraform
      parallelism: 1
      variables:
        name: "us-west-test"
        network_zone: "us-west"
        network_cidr: "10.3.0.0/16"
        ssh_key_id: "12940863"
    verifier:
      name: terraform
      systems:
        - <<: *terraform_verifier
          attrs:
            - test/integration/default/terraform_attributes/us_west.yml
        - <<: *nat_gateway_verifier
          attrs:
            - test/integration/default/terraform_attributes/us_west.yml
            - test/integration/default/terraform_attributes/all.yml
        - <<: *grafana_verifier
          attrs:
            - test/integration/default/terraform_attributes/us_west.yml
            - test/integration/default/terraform_attributes/all.yml
        - <<: *private_network_server
          attrs:
            - test/integration/default/terraform_attributes/us_west.yml
            - test/integration/default/terraform_attributes/all.yml

suites:
  - name: default
